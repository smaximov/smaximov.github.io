<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Rails | Без названия]]></title>
  <link href="http://smaximov.github.io/blog/categories/rails/atom.xml" rel="self"/>
  <link href="http://smaximov.github.io/"/>
  <updated>2013-06-26T00:34:33+11:00</updated>
  <id>http://smaximov.github.io/</id>
  <author>
    <name><![CDATA[Сергей Максимов]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Генерация PDF с помощью Prawn]]></title>
    <link href="http://smaximov.github.io/blog/2013/06/21/generating-pdf-in-rails-with-prawn/"/>
    <updated>2013-06-21T18:17:00+11:00</updated>
    <id>http://smaximov.github.io/blog/2013/06/21/generating-pdf-in-rails-with-prawn</id>
    <content type="html"><![CDATA[<h1 id="toc_24">Введение</h1>

<p>Динамическое создание PDF &mdash; довольно распространенное задача.
Для Ruby существует несколько библиотек для генерации с PDF-файлов,
вот некоторые из них:</p>

<ul>
<li><p><a href="https://github.com/pdfkit/pdfkit">PDFkit</a> &mdash; библиотека для конвертации HTML в PDF. Использует
shell-утилиту <a href="http://code.google.com/p/wkhtmltopdf/">wkhtmltopdf</a>, которая, в свою очередь,
использует webkit в качестве движка рендеринга;</p></li>
<li><p><a href="https://github.com/mileszs/wicked_pdf">Wicked pdf</a> &mdash; тоже конвертация HTML &rarr; PDF,
тоже <a href="http://code.google.com/p/wkhtmltopdf/">wkhtmltopdf</a>;</p></li>
<li><p><a href="https://github.com/fnando/kitabu">Kitabu</a> &mdash; генерация PDF и e-Pub из Textile, Markdown
или HTML;</p></li>
<li><p><a href="http://prawn.majesticseacreature.com/">Prawn</a> &mdash; библиотека для создания PDF-файлов,
написанная на чистом Ruby.</p></li>
</ul>

<p>Таким образом, видны две тенденции: генерация PDF из какого-нибудь
языка разметки либо использование DSL для генерации.</p>

<p>Мой выбор пал на Prawn, о нем и будет рассказано в остальной части
поста.</p>

<!-- more -->

<h1 id="toc_25">Установка и настройка</h1>

<p>Установка проста: добавьте следующую строку в <code>Gemfile</code>:</p>
<div class="highlight"><pre><span class="n">gem</span> <span class="s1">&#39;prawn&#39;</span>
</pre></div>
<p>Затем нужно добавить в <code>config/application.rb</code> автозагрузку файлов из
директории <code>/app/pdfs/</code>, в которой мы будем хранить классы, создающие
PDF-файлы:</p>
<div class="highlight"><pre><code class="ruby"><span class="k">module</span> <span class="nn">Biotriz</span>
  <span class="k">class</span> <span class="nc">Application</span> <span class="o">&lt;</span> <span class="no">Rails</span><span class="o">::</span><span class="no">Application</span>
    <span class="n">config</span><span class="o">.</span><span class="n">autoload_paths</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="no">Rails</span><span class="o">.</span><span class="n">root</span><span class="si">}</span><span class="s2">/app/pdfs&quot;</span>
    <span class="c1"># ... skipped ...</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Далее зарегистрируем Mime-тип <code>:pdf</code> в
<code>/config/initializers/mime_types.rb</code>:</p>
<div class="highlight"><pre><code class="ruby"><span class="no">Mime</span><span class="o">::</span><span class="no">Type</span><span class="o">.</span><span class="n">register</span> <span class="s1">&#39;application/pdf&#39;</span><span class="p">,</span> <span class="ss">:pdf</span>
</code></pre>
</div>

<p>Это позволит нам указывать тип <code>:pdf</code> в методе <code>send_data</code>, а также
использовать его в блоке <code>respond_to</code>.</p>

<h1 id="toc_26">Использование</h1>

<p>Код класса, создающего PDF:</p>
<div class="highlight"><pre><code class="ruby"><span class="c1"># encoding: utf-8</span>

<span class="nb">require</span> <span class="s2">&quot;prawn/measurement_extensions&quot;</span>

<span class="k">class</span> <span class="nc">SearchResults</span> <span class="o">&lt;</span> <span class="no">Prawn</span><span class="o">::</span><span class="no">Document</span>
  <span class="kp">include</span> <span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">url_helpers</span>
  <span class="kp">include</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">Routing</span><span class="o">::</span><span class="no">PolymorphicRoutes</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">entries</span><span class="p">,</span> <span class="n">host</span><span class="p">)</span>
    <span class="k">super</span><span class="p">()</span>
    <span class="n">pad</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">font</span><span class="p">(</span><span class="s2">&quot;Helvetica&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span> <span class="n">style</span><span class="p">:</span> <span class="ss">:bold</span><span class="p">)</span> <span class="k">do</span>
        <span class="n">text</span> <span class="s2">&quot;Search Results (</span><span class="si">#{</span><span class="no">Time</span><span class="o">.</span><span class="n">zone</span><span class="o">.</span><span class="n">now</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%d/%m/%Y %H:%M&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">pad_bottom</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">font</span><span class="p">(</span><span class="s2">&quot;Helvetica&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span> <span class="n">style</span><span class="p">:</span> <span class="ss">:bold</span><span class="p">)</span> <span class="k">do</span>
        <span class="n">pad_bottom</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="k">do</span>
          <span class="n">text</span> <span class="s2">&quot;Search Query&quot;</span>
        <span class="k">end</span>
      <span class="k">end</span>

      <span class="n">query_output</span> <span class="o">=</span> <span class="o">[]</span>
      <span class="n">first</span> <span class="o">=</span> <span class="kp">false</span>

      <span class="n">query</span><span class="o">.</span><span class="n">try</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">item</span><span class="o">|</span>
        <span class="n">color</span> <span class="o">=</span> <span class="n">item</span><span class="o">[</span><span class="ss">:color</span><span class="o">][</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="o">-</span><span class="mi">1</span><span class="o">]</span>
        <span class="n">cls</span> <span class="o">=</span> <span class="n">item</span><span class="o">[</span><span class="ss">:model</span><span class="o">].</span><span class="n">classify</span><span class="o">.</span><span class="n">constantize</span>

        <span class="n">item</span><span class="o">[</span><span class="ss">:values</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">value</span><span class="o">|</span>
          <span class="n">query_output</span> <span class="o">&lt;&lt;</span> <span class="p">{</span>
            <span class="n">text</span><span class="p">:</span> <span class="s2">&quot;[</span><span class="si">#{</span><span class="n">value</span><span class="o">.</span><span class="n">title</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">,</span>
            <span class="n">link</span><span class="p">:</span> <span class="n">polymorphic_url</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">host</span><span class="p">:</span> <span class="n">host</span><span class="p">)</span>
          <span class="p">}</span>

          <span class="k">if</span> <span class="ow">not</span> <span class="n">first</span>
            <span class="n">query_output</span> <span class="o">&lt;&lt;</span> <span class="p">{</span> <span class="n">text</span><span class="p">:</span> <span class="s2">&quot;   &quot;</span> <span class="p">}</span>
            <span class="n">first</span> <span class="o">=</span> <span class="kp">false</span>
          <span class="k">end</span>
        <span class="k">end</span>
      <span class="k">end</span>

      <span class="n">formatted_text</span> <span class="n">query_output</span><span class="p">,</span> <span class="n">leading</span><span class="p">:</span> <span class="mi">10</span>
    <span class="k">end</span>

    <span class="n">pad_bottom</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">font</span><span class="p">(</span><span class="s2">&quot;Helvetica&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span> <span class="n">style</span><span class="p">:</span> <span class="ss">:bold</span><span class="p">)</span> <span class="k">do</span>
        <span class="n">pad_bottom</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="k">do</span>
          <span class="n">text</span> <span class="s2">&quot;Search Results&quot;</span>
        <span class="k">end</span>
      <span class="k">end</span>
      <span class="n">entries</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">entry</span><span class="o">|</span>
        <span class="n">pad_bottom</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="k">do</span>
          <span class="n">font</span><span class="p">(</span><span class="s2">&quot;Helvetica&quot;</span><span class="p">,</span> <span class="n">style</span><span class="p">:</span> <span class="ss">:bold</span><span class="p">)</span> <span class="k">do</span>
            <span class="n">formatted_text</span> <span class="o">[</span><span class="p">{</span><span class="n">text</span><span class="p">:</span> <span class="n">entry</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="n">link</span><span class="p">:</span> <span class="n">polymorphic_url</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">host</span><span class="p">:</span> <span class="n">host</span><span class="p">)}</span><span class="o">]</span>
          <span class="k">end</span>
        <span class="k">end</span>

        <span class="n">pad_bottom</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span> <span class="k">do</span>
          <span class="n">text</span> <span class="n">entry</span><span class="o">.</span><span class="n">description</span><span class="p">,</span> <span class="n">indent_paragraphs</span><span class="p">:</span> <span class="mi">1</span><span class="o">.</span><span class="mi">5</span><span class="o">.</span><span class="n">cm</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Особо комментировать этот код не буду, как по мне, он говорит сам за
себя; желающие могут обратиться к документации <a href="http://prawn.majesticseacreature.com/">на сайте</a>, там
же есть мануал.</p>

<p>Код действия, формирующего и отсылающего PDF-файл клиенту:</p>
<div class="highlight"><pre><code class="ruby">  <span class="k">def</span> <span class="nf">save</span>
    <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
      <span class="c1"># ... skipped ...</span>
      <span class="nb">format</span><span class="o">.</span><span class="n">pdf</span> <span class="k">do</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">restore_query</span> <span class="n">params</span><span class="o">[</span><span class="ss">:query</span><span class="o">]</span>
        <span class="n">reverted_query</span> <span class="o">=</span> <span class="n">revert_query</span> <span class="n">query</span><span class="p">:</span> <span class="n">query</span>
        <span class="n">host</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">host_with_port</span>
        <span class="n">entries</span> <span class="o">=</span> <span class="c1"># ... skipped ...</span>
        <span class="n">send_data</span> <span class="no">SearchResults</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">reverted_query</span><span class="p">,</span> <span class="n">entries</span><span class="p">,</span> <span class="n">host</span><span class="p">)</span><span class="o">.</span><span class="n">render</span><span class="p">,</span>
                  <span class="n">filename</span><span class="p">:</span> <span class="s2">&quot;search.pdf&quot;</span><span class="p">,</span>
                  <span class="n">type</span><span class="p">:</span> <span class="ss">:pdf</span><span class="p">,</span>
                  <span class="n">disposition</span><span class="p">:</span> <span class="s2">&quot;attachment&quot;</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
</code></pre>
</div>

<h1 id="toc_27">Заключение</h1>

<p>С помощью библиотеки Prawn можно относительно легко генерировать простые
(и не очень) PDF-файлы. Возможно, подход, выбранный создателями
библиотеки (DSL), не самый оптимальный, но со своей задачей она
справляется на отлично.</p>

<p>Однако, я даю себе слово попробовать и подход с генерацией PDF из
файлов, написанных на языках разметки ☺</p>
]]></content>
  </entry>
  
</feed>
